<launch>

  <arg name="type" default="physical"/> <!-- physical, simulated, planner : used for prefix -->
  <arg name="ip_address" default="127.0.0.1"/>
  <arg name="fake_gripper" default="true"/>

  <arg name="timestep" default="0.12"/>
  <arg name="lookahead" default="0.1"/>
  <arg name="gain" default="100"/>
  <arg name="time_scalars" default="[100,100,100,100,100,100]"/>

  <!-- Launch robot driver -->
  <include file="$(find ur_robot_driver)/launch/ur_common.launch">
    <arg name="debug" value="false"/>
    <arg name="use_tool_communication" value="false"/>
    <arg name="controller_config_file" value="$(find ur_robot_driver)/config/ur3_controllers.yaml"/>
    <arg name="robot_description_file" value="$(find ur_description)/launch/ur3_upload.launch"/>
    <arg name="robot_ip" value="$(arg ip_address)"/>
    <arg name="reverse_port" value="50001"/>
    <arg name="script_sender_port" value="50002"/>
    <arg name="kinematics_config" value="$(find ur_description)/config/ur3_default.yaml"/>
    <arg name="limited" value="false"/>
    <arg name="tf_prefix" value="$(arg type)_"/>
    <arg name="controllers" value="joint_state_controller scaled_pos_traj_controller speed_scaling_state_controller force_torque_sensor_controller"/>
    <arg name="stopped_controllers" value="pos_traj_controller joint_group_vel_controller"/>
    <arg name="headless_mode" value="false"/>
  </include>

  <!-- Launch gripper driver -->
  <node if="$(arg fake_gripper)" pkg="robotiq_85_driver" type="fake_robotiq_85_driver" name="fake_robotiq_85_driver" respawn="true" output="screen"/>
  <node unless="$(arg fake_gripper)" pkg="robotiq_85_driver" type="robotiq_85_driver_remote_serial" name="robotiq_85_driver" respawn="true" output="screen">
      <param name="num_grippers" value="1" />
      <param name="comport" value="/tmp/ttyUR" />
      <param name="baud" value="115200" />
  </node>

  <!-- Handle Robot State -->
  <group if="$(arg local)">
    <node name="joint_remapper" pkg="cobots_ur_bringup" type="joint_remapper.py">
      <rosparam param="input_topics">[gripper/joint_state]</rosparam>
      <param name="output_topic" value="joint_states"/>
      <param name="prefix" value="$(arg type)_"/>
    </node>
  </group>

  <!-- Higher-level controller for communication with cobots -->
  <node name="ur_controller" pkg="cobots_ur_bringup" type="ur_controller.py" output="screen">

    <!-- Servoing parameters -->
    <param name="timestep" value="$(arg timestep)"/>
    <param name="lookahead" value="$(arg lookahead)"/>
    <param name="gain" value="$(arg gain)"/>
    <rosparam param="time_scalars" subst_value="true">$(arg time_scalars)</rosparam>

  </node>

</launch>
